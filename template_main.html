<!DOCTYPE html>
<html>
<link rel="shortcut icon" href="lambda?val=favicon" />
<head>
<title>Human Calc</title>
<style>
input[type="text"],input[type="number"],textarea {
    background: #272822;
    color: #cec;
    font-family: Menlo,Monaco,Consolas,monospace;
    font-size: 12pt;
    border-top-style: hidden;
    border-right-style: hidden;
    border-left-style: hidden;
    border-bottom-style: hidden;
    padding: 2px;
    outline: none;
}

input[type="text"]:focus,input[type="number"]:focus,textarea:focus {
    background-color: #000;
    border-bottom-style: solid;
    border-bottom-width: 1px;
    border-bottom-color: #a8a8f2;
}

body {
    padding: 1em;
    word-break: break-word;
    background: #272822;
    color: #f8f8f2;
    font-family: Menlo,Monaco,Consolas,monospace;
    font-size: 12pt;
}
</style>
<script>
var states = {1: ""};
var getJSON = function(url, data, extra, callback) {
    var xhr = new XMLHttpRequest();
    xhr.open('POST', url, true);
    xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
    xhr.responseType = 'json';
    xhr.onload = function() {
        var status = xhr.status;
        if (status === 200) {
            callback(null, xhr.response, extra);
        } else {
            callback(status, xhr.response, extra);
        }
    };
    temp = "";
    for (const [key, value] of Object.entries(data)) {
        if (temp.length > 0) {
            temp += "&";
        }
        temp += key + "=" + encodeURIComponent(value);
    }
    xhr.send(temp);
};

function run_calc(num, value, move_focus) {
    if (value.length > 0) {
        var data = {
            "val": "calc",
            "f": value,
            "s": states[num]
        };
        getJSON('lambda', data, [num, move_focus], get_results);
    }
}

function get_results(err, data, extra) {
    var num = extra[0];
    var move_focus = extra[1];
    states[num + 1] = data["state"];

    if (num > 0) {
        var input = document.getElementById("result_" + num);
        if (input == null) {
            var cur = document.getElementById('div_entry_' + num);
            var div = document.createElement('div');
            div.id = "div_result_" + num;
            var span = document.createElement("span");
            span.innerHTML = "=";
            span.style = "color:#999";
            div.appendChild(span);
            var input = document.createElement('input');
            input.id = "result_" + num;
            input.size = 50;
            input.type = "text";
            input.value = data["result"];
            input.readOnly = true;

            div.appendChild(input);
            cur.parentElement.appendChild(div);
        } else {
            input.value = data["result"];
        }
    }

    var input = document.getElementById("entry_" + (num + 1));
    if (input == null) {
        var div = document.createElement('div');
        div.id = "div_entry_" + (num + 1);
        var input = document.createElement('input');
        input.onkeypress = function(e){return entry_press(num + 1, e);};
        input.id = "entry_" + (num + 1);
        input.size = 50;
        input.type = "text";
        input.placeholder = "Enter formula here and hit enter";
        div.appendChild(input);
        if (num == 0) {
            document.getElementById('ticker').appendChild(div);
        } else {
            cur.parentElement.appendChild(div);
        }
    } else {
        run_calc(num + 1, input.value, false);
    }

    if (move_focus) {
        input.focus();
    }
}

function entry_press(num, e) {
    e = e || window.event;
    if (e.keyCode == 13) {
        run_calc(num, document.getElementById('entry_' + num).value, true);
        return false;
    }
    return true;
}

function loaded() {
    get_results(null, {"state":""}, [0, true]);
}
</script>
</head>
<body onload="loaded()">
<div id="ticker"></div>
</body>
</html>
